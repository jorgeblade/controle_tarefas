<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEPARTAMENTO OPERACIONAL: Painel de Tarefas Diárias</title>
    <!-- Importa o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Define a fonte Inter (padrão do Tailwind) */
        body { font-family: "Inter", sans-serif; }
        
        /* Estilos para cores dos cards de tarefa (bordas laterais) */
        .task-card {
            border-left-width: 4px;
            /* Garante que o cartão ocupe a altura total do grid */
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .task-done { border-color: #10B981; } /* Emerald-500 */
        .task-pending { border-color: #F59E0B; } /* Amber-500 */
        .task-in-progress { border-color: #3B82F6; } /* Blue-500 */

        /* Estilo para a barra de rolagem dos cartões */
        .task-scroll-area::-webkit-scrollbar {
            width: 6px;
        }
        .task-scroll-area::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 3px;
        }
        .task-scroll-area {
            scrollbar-width: thin;
            scrollbar-color: #d1d5db transparent;
        }

        /* Estilos para o Modal */
        .modal-overlay {
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            z-index: 1001;
            max-width: 90%;
            max-height: 90%;
        }

        /* Estilos para impressão (Exportar PDF) */
        @media print {
            body {
                background-color: white !important;
                padding: 0;
            }
            /* Esconde o painel de botões, o dashboard e o modal na impressão */
            .no-print, .modal-overlay {
                display: none !important;
            }
            /* Otimiza a grade para layout de coluna única na impressão */
            #tasks-grid {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
            }
            .task-card {
                page-break-inside: avoid;
                margin-bottom: 1rem;
                height: auto;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-6 text-center">
            DEPARTAMENTO OPERACIONAL: Tarefas Diárias Relevantes
        </h1>

        <!-- Container para Mensagens de Feedback (Salvo com sucesso, Erro, etc.) -->
        <div id="message-container" class="fixed top-4 right-4 z-50 transition-all duration-300 transform"></div>

        <!-- Dashboard de KPIs de Tarefas (Novo) -->
        <div id="dashboard-container" class="mb-6 no-print">
            <!-- KPIs renderizados aqui -->
        </div>

        <!-- Conteúdo do Painel de Tarefas -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-2xl">
            <div class="text-center p-10 text-lg font-medium text-indigo-600" id="loading-initial">
                <!-- Ícone de Carregamento -->
                <svg class="animate-spin h-6 w-6 mr-3 inline text-indigo-600" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Carregando painel...
            </div>
            <!-- Painel de Tarefas Diárias (Grid) -->
            <div id="tasks-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4" style="height: 600px; overflow-y: auto;">
                <!-- Cartões de tarefas renderizados aqui -->
            </div>
        </div>

        <!-- PAINEL DE AÇÕES (Expandido para 4 botões) -->
        <div class="text-center mt-6 p-4 bg-white rounded-xl shadow-lg grid grid-cols-2 md:grid-cols-4 gap-4 no-print">
            
            <button
                id="save-tasks-btn"
                onclick="saveTasks()"
                class="px-3 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition duration-200 disabled:bg-indigo-400 disabled:cursor-not-allowed text-sm md:text-base"
            >
                Salvar Localmente
            </button>

            <button
                onclick="exportDataAsJSON()"
                class="px-3 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transition duration-200 text-sm md:text-base"
            >
                Exportar Dados (JSON)
            </button>
            
            <button
                onclick="importDataFromJSON()"
                class="px-3 py-3 bg-purple-600 text-white font-semibold rounded-full shadow-lg hover:bg-purple-700 transition duration-200 text-sm md:text-base"
            >
                Importar Dados (JSON)
            </button>

            <button
                onclick="resetTasks()"
                class="px-3 py-3 bg-red-600 text-white font-semibold rounded-full shadow-lg hover:bg-red-700 transition duration-200 text-sm md:text-base"
            >
                Zerar Ciclo
            </button>

             <button
                onclick="exportToPDF()"
                class="col-span-2 md:col-span-4 px-3 py-3 bg-emerald-600 text-white font-semibold rounded-full shadow-lg hover:bg-emerald-700 transition duration-200 text-sm md:text-base"
            >
                Gerar PDF (Imprimir Painel Completo)
            </button>

        </div>
    </div>

    <!-- MODAL DE DETALHES DA TAREFA (NOVO) -->
    <div id="task-detail-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4" onclick="closeTaskDetailModal()">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full md:w-1/2 lg:w-1/3" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Detalhes da Tarefa</h3>
            
            <div id="modal-body" class="space-y-4">
                <div class="flex items-center justify-between">
                    <label for="modal-status" class="font-semibold text-gray-700">Status:</label>
                    <select id="modal-status" class="p-2 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div>
                    <label for="modal-description" class="font-semibold text-gray-700 block mb-1">Descrição Detalhada:</label>
                    <textarea 
                        id="modal-description" 
                        rows="6" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 resize-y"
                        placeholder="Detalhes e passos para executar a tarefa..."
                    ></textarea>
                </div>
                
                <p id="modal-day-info" class="text-xs text-gray-500 text-right"></p>

            </div>

            <div class="mt-6 flex justify-end gap-3 border-t pt-4">
                <button 
                    onclick="closeTaskDetailModal()"
                    class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition"
                >
                    Fechar
                </button>
                <button 
                    id="modal-save-btn"
                    onclick="saveTaskDetailFromModal()"
                    class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-md hover:bg-indigo-700 transition"
                >
                    Salvar Alterações
                </button>
            </div>
        </div>
    </div>
    
    <!-- LÓGICA PRINCIPAL EM JAVASCRIPT VANILLA -->
    <script>
        // --- VARIÁVEIS DE ESTADO E AMBIENTE ---
        let dailyTasks = null;
        let isAppReady = false;
        let activeTaskInModal = null; // Guarda {dayIndex, taskId} da tarefa aberta

        // Chave do localStorage
        const TASKS_STORAGE_KEY = 'blade_daily_tasks_v2'; 

        // Mapeamento de Status
        const STATUS_OPTIONS = [
            { value: 'Pendente', name: 'Pendente', color: 'bg-amber-100 text-amber-800 border-amber-500' },
            { value: 'Em Andamento', name: 'Em Andamento', color: 'bg-blue-100 text-blue-800 border-blue-500' },
            { value: 'Executada', name: 'Executada', color: 'bg-emerald-100 text-emerald-800 border-emerald-500' },
        ];


        // --- FUNÇÕES DE UTILIDADE ---
        const showMessage = (text, isError = false) => {
            const container = document.getElementById('message-container');
            container.innerHTML = `
                <div class="p-4 rounded-lg shadow-xl font-medium transition-all duration-300 transform animate-pulse
                    ${isError ? 'bg-red-100 text-red-800' : 'bg-indigo-100 text-indigo-800'}" role="alert">
                    ${text}
                </div>
            `;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        };
        
        const getNextTaskId = (tasks) => {
            return tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
        };

        // --- ESTRUTURA DE DADOS INICIAIS ---
        const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
        const createInitialTasksData = () => {
            const initialData = [];
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const day = new Date(today);
                day.setDate(today.getDate() + i);
                
                initialData.push({ 
                    dayIndex: i, // Novo campo para facilitar a manipulação no JS
                    dia: i + 1, 
                    dataCompleta: day.toISOString().split('T')[0], // YYYY-MM-DD
                    dataFormatada: `${day.getDate().toString().padStart(2, '0')}/${(day.getMonth() + 1).toString().padStart(2, '0')}`,
                    diaSemana: dayNames[day.getDay()],
                    tarefas: [], // Array de tarefas
                });
            }
            // Adiciona algumas tarefas de exemplo
            if (initialData[0]) {
                initialData[0].tarefas.push(
                    { id: 1, descricao: 'Definir proposta de valor final', status: 'Em Andamento' },
                    { id: 2, descricao: 'Pesquisar 5 fornecedores principais e preparar uma lista de comparação de preços.', status: 'Pendente' }
                );
            }
             if (initialData[1]) {
                initialData[1].tarefas.push(
                    { id: 1, descricao: 'Contatar Designer (se necessário) para esboçar o logo e as cores primárias da marca.', status: 'Pendente' }
                );
            }
            return initialData;
        };

        // --- GESTÃO DE DADOS LOCAIS (localStorage) ---
        
        const loadDataFromLocalStorage = () => {
            try {
                const storedTasks = localStorage.getItem(TASKS_STORAGE_KEY);
                dailyTasks = storedTasks ? JSON.parse(storedTasks) : createInitialTasksData();
                
                // MANTÉM compatibilidade e garante 30 dias
                if (!Array.isArray(dailyTasks) || dailyTasks.length !== 30 || !dailyTasks[0].tarefas) {
                    dailyTasks = createInitialTasksData();
                } else {
                    // Garante que o dayIndex existe se estiver carregando dados antigos
                     dailyTasks = dailyTasks.map((day, index) => ({
                        ...day,
                        dayIndex: index,
                    }));
                }

                console.log("Tarefas carregadas do localStorage.");
            } catch (error) {
                console.error("Erro ao carregar dados do localStorage:", error);
                dailyTasks = createInitialTasksData();
            }
        };

        const saveTasksToLocalStorage = (data) => {
            try {
                localStorage.setItem(TASKS_STORAGE_KEY, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error("Erro ao salvar Tarefas no localStorage:", error);
                showMessage("Erro: Falha ao salvar o Painel de Tarefas localmente.", true);
                return false;
            }
        };

        window.saveTasks = () => {
            const saveButton = document.getElementById('save-tasks-btn');
            if(saveButton) {
                saveButton.disabled = true;
                saveButton.innerText = 'Salvando...';
            }
            
            const success = saveTasksToLocalStorage(dailyTasks);

            if(saveButton) {
                saveButton.disabled = false;
                saveButton.innerText = 'Salvar Localmente';
            }
            if (success) showMessage("Painel de Tarefas salvo com sucesso!");
        };

        // --- NOVO: EXPORTAÇÃO DE DADOS (JSON) ---
        window.exportDataAsJSON = () => {
            try {
                const dataStr = JSON.stringify(dailyTasks, null, 2);
                // Cria um Blob e um URL para download
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const exportFileName = `DEPARTAMENTO_OPERACIONAL_Tarefas_${new Date().toISOString().slice(0, 10)}.json`;

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', url);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                // Limpeza
                URL.revokeObjectURL(url);
                showMessage("Dados exportados! Transfira este arquivo JSON para outro dispositivo para sincronizar.");
            } catch (error) {
                showMessage("Erro ao exportar dados.", true);
                console.error("Export Error:", error);
            }
        };

        // --- NOVO: IMPORTAÇÃO DE DADOS (JSON) ---
        window.importDataFromJSON = () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'application/json';

            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validação básica: verifica se é uma estrutura de 30 dias com array de tarefas
                        if (Array.isArray(importedData) && importedData.length === 30 && importedData[0].tarefas) {
                            
                            // Atualiza o estado e garante que o dayIndex está correto
                            dailyTasks = importedData.map((day, index) => ({
                                ...day,
                                dayIndex: index,
                            }));
                            
                            saveTasksToLocalStorage(dailyTasks); // Salva os dados importados no navegador atual
                            renderApplication();
                            showMessage("Dados importados e sincronizados localmente com sucesso!");

                        } else {
                            showMessage("Erro: Arquivo JSON inválido ou incompatível. Certifique-se de que é um arquivo de tarefas BLADETEC.", true);
                        }
                    } catch (error) {
                        showMessage("Erro ao processar o arquivo JSON. Certifique-se de que é um JSON válido.", true);
                        console.error("Import Error:", error);
                    }
                };
                reader.readAsText(file);
            };

            fileInput.click();
        };

        // --- ZERAR DADOS E INICIAR NOVO CICLO ---
        window.resetTasks = () => {
             // Utiliza uma simulação de modal com a mensagem, já que alert/confirm são proibidos
             const confirmMessage = "Tem certeza que deseja apagar TODOS os dados do Painel de Tarefas e iniciar um novo ciclo de 30 dias? Esta ação é irreversível!";
             
             const currentButtonHtml = document.querySelector('[onclick="resetTasks()"]').innerHTML;
             const buttonElement = document.querySelector('[onclick="resetTasks()"]');

             if (buttonElement.innerText.includes("CONFIRMAR")) {
                 // Confirmação recebida
                 try {
                    localStorage.removeItem(TASKS_STORAGE_KEY);
                    dailyTasks = createInitialTasksData(); // Recria a estrutura
                    renderApplication();
                    showMessage("Dados zerados com sucesso! Novo ciclo de 30 dias iniciado.", false);
                    buttonElement.innerHTML = currentButtonHtml; // Volta ao normal
                 } catch (error) {
                    showMessage("Erro ao zerar dados.", true);
                 }
             } else {
                 // Primeira clicada: pede confirmação
                 showMessage(confirmMessage, true);
                 buttonElement.innerHTML = 'CONFIRMAR? Clique para Zerar!';
                 
                 // Reseta o botão após 3 segundos, caso o usuário não clique
                 setTimeout(() => {
                     if (buttonElement.innerText.includes("CONFIRMAR")) {
                        buttonElement.innerHTML = currentButtonHtml;
                     }
                 }, 3000);
             }
        };

        // --- EXPORTAR PARA PDF (USANDO IMPRESSÃO NATIVA) ---
        window.exportToPDF = () => {
            showMessage("Gerando pré-visualização de impressão (PDF)...");
            window.print();
        };


        // --- FUNÇÕES DE MANIPULAÇÃO DE TAREFAS (Ações de CRUD) ---
        
        window.addTask = (dayIndex) => {
            const dayData = dailyTasks[dayIndex];
            const inputElement = document.getElementById(`new-task-input-${dayIndex}`);

            if (!dayData || !inputElement) return;

            const newTaskId = getNextTaskId(dayData.tarefas);
            const newTaskDesc = inputElement.value.trim();
            
            if (newTaskDesc.length < 3) {
                showMessage("A descrição da tarefa deve ter pelo menos 3 caracteres.", true);
                return;
            }

            dayData.tarefas.push({
                id: newTaskId,
                descricao: newTaskDesc,
                status: 'Pendente',
            });
            
            inputElement.value = ''; // Limpa o input
            
            // Re-renderiza e salva
            renderApplication();
            saveTasksToLocalStorage(dailyTasks);
        };

        window.updateTask = (dayIndex, taskId, field, value) => {
            const dayData = dailyTasks[dayIndex];
            if (!dayData) return;

            const task = dayData.tarefas.find(t => t.id === taskId);
            if (task) {
                if (field === 'descricao') {
                    task.descricao = value;
                } else if (field === 'status') {
                    task.status = value;
                    // Força a re-renderização para atualizar a cor do card/dashboard
                    renderApplication(); 
                }
                
                // Salva automaticamente no localStorage
                saveTasksToLocalStorage(dailyTasks);
            }
        };
        
        window.deleteTask = (dayIndex, taskId) => {
            const dayData = dailyTasks[dayIndex];
            if (!dayData) return;

            dayData.tarefas = dayData.tarefas.filter(t => t.id !== taskId);
            
            // Re-renderiza para remover a tarefa e atualiza o dashboard
            renderApplication();

            // Salva automaticamente no localStorage
            saveTasksToLocalStorage(dailyTasks);
        };
        
        // --- NOVO: LÓGICA DO MODAL ---
        window.openTaskDetailModal = (dayIndex, taskId) => {
            const day = dailyTasks[dayIndex];
            const task = day.tarefas.find(t => t.id === taskId);

            if (!task) return showMessage("Erro: Tarefa não encontrada.", true);

            activeTaskInModal = { dayIndex, taskId };

            // 1. Preenche o status
            const statusSelect = document.getElementById('modal-status');
            statusSelect.innerHTML = STATUS_OPTIONS.map(opt => `
                <option value="${opt.value}" ${task.status === opt.value ? 'selected' : ''}>
                    ${opt.name}
                </option>
            `).join('');

            // 2. Preenche a descrição
            document.getElementById('modal-description').value = task.descricao;

            // 3. Preenche info do dia
            document.getElementById('modal-day-info').innerText = `Dia: ${day.dataFormatada} (${day.diaSemana})`;

            // 4. Exibe o modal
            document.getElementById('task-detail-modal').classList.remove('hidden');
        };

        window.closeTaskDetailModal = () => {
            document.getElementById('task-detail-modal').classList.add('hidden');
            activeTaskInModal = null;
            // Força o re-render para garantir que a grade está atualizada (caso o usuário tenha editado o status pelo modal)
            renderApplication();
        };

        window.saveTaskDetailFromModal = () => {
            if (!activeTaskInModal) return;

            const { dayIndex, taskId } = activeTaskInModal;
            
            const newDescription = document.getElementById('modal-description').value.trim();
            const newStatus = document.getElementById('modal-status').value;
            
            // 1. Atualiza o estado
            const dayData = dailyTasks[dayIndex];
            const task = dayData.tarefas.find(t => t.id === taskId);

            if (task) {
                task.descricao = newDescription;
                task.status = newStatus;
                
                // 2. Salva e fecha
                saveTasksToLocalStorage(dailyTasks);
                showMessage("Detalhes da tarefa salvos e painel atualizado.");
                closeTaskDetailModal(); 
            }
        };
        // --- FIM LÓGICA DO MODAL ---


        // --- CÁLCULOS DO DASHBOARD (KPIs) ---

        const calculateTaskKPIs = (data) => {
            if (!data || data.length === 0) {
                return { total: 0, completed: 0, pending: 0, inProgress: 0, dailyProgress: '0%', weeklyProgress: '0%' };
            }
            
            // 1. Cálculos de 30 dias (Geral)
            let total = 0;
            let completed = 0;
            let pending = 0;
            let inProgress = 0;

            // 2. Cálculos de Período Específico
            let dailyTotal = 0;
            let dailyCompleted = 0;
            let weeklyTotal = 0;
            let weeklyCompleted = 0;
            
            const todayIndex = 0; // O dia atual é sempre o primeiro item do array
            
            data.forEach((day, index) => {
                day.tarefas.forEach(task => {
                    total++;
                    if (task.status === 'Executada') completed++;
                    else if (task.status === 'Pendente') pending++;
                    else if (task.status === 'Em Andamento') inProgress++;
                });

                // Calcula o progresso diário (Dia 0)
                if (index === todayIndex) {
                    day.tarefas.forEach(task => {
                        dailyTotal++;
                        if (task.status === 'Executada') dailyCompleted++;
                    });
                }

                // Calcula o progresso semanal (Dias 0 a 6)
                if (index >= todayIndex && index < todayIndex + 7) {
                    day.tarefas.forEach(task => {
                        weeklyTotal++;
                        if (task.status === 'Executada') weeklyCompleted++;
                    });
                }
            });

            const dailyProgress = dailyTotal > 0 ? ((dailyCompleted / dailyTotal) * 100).toFixed(0) : 0;
            const weeklyProgress = weeklyTotal > 0 ? ((weeklyCompleted / weeklyTotal) * 100).toFixed(0) : 0;
            
            return { total, completed, pending, inProgress, dailyProgress: `${dailyProgress}%`, weeklyProgress: `${weeklyProgress}%` };
        };

        // --- RENDERING COMPONENTS (Geração de HTML) ---

        const renderKPICard = (title, value, color) => `
            <div class="p-4 rounded-xl shadow-md ${color}">
                <p class="text-sm font-medium opacity-80">${title}</p>
                <p class="text-2xl font-extrabold mt-1">${value}</p>
            </div>
        `;

        const renderTaskDashboard = (kpis) => {
            const kpiCards = [
                renderKPICard("Progresso Hoje", kpis.dailyProgress, "bg-indigo-100 text-indigo-800"),
                renderKPICard("Progresso Semanal", kpis.weeklyProgress, "bg-blue-100 text-blue-800"),
                renderKPICard("Tarefas Concluídas (30d)", kpis.completed, "bg-emerald-100 text-emerald-800"),
                renderKPICard("Tarefas Pendentes (30d)", kpis.pending, "bg-amber-100 text-amber-800"),
                renderKPICard("Total de Tarefas (30d)", kpis.total, "bg-gray-200 text-gray-800"),
            ].join('');

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Métricas de Execução</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                        ${kpiCards}
                    </div>
                </div>
            `;
        };

        // Renderiza a grade de tarefas
        const renderTasksGrid = (data) => {
            const getTaskCardColor = (status) => {
                const statusMap = {
                    'Executada': 'task-done',
                    'Pendente': 'task-pending',
                    'Em Andamento': 'task-in-progress',
                };
                return statusMap[status] || 'border-gray-300';
            };
            
            return data.map((day) => {
                const tasksHtml = day.tarefas.map(task => {
                    const statusConfig = STATUS_OPTIONS.find(opt => opt.value === task.status) || STATUS_OPTIONS[0];
                    return `
                        <div class="p-3 mb-2 rounded-lg shadow-sm border border-gray-200 bg-white">
                            <div class="flex items-center justify-between gap-2">
                                <!-- NOVO: Adicionado onclick para abrir o modal -->
                                <input
                                    type="text"
                                    id="task-desc-${day.dayIndex}-${task.id}"
                                    value="${task.descricao}"
                                    onclick="openTaskDetailModal(${day.dayIndex}, ${task.id})"
                                    onchange="updateTask(${day.dayIndex}, ${task.id}, 'descricao', this.value)"
                                    class="text-sm font-medium text-gray-800 w-full bg-transparent border border-transparent hover:border-gray-200 p-1 -m-1 rounded focus:border-indigo-500 focus:ring-0 cursor-pointer"
                                    readonly
                                />
                                <button onclick="deleteTask(${day.dayIndex}, ${task.id})" class="text-red-400 hover:text-red-600 transition flex-shrink-0">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                            <div class="mt-2 flex items-center justify-between">
                                <span class="text-xs font-semibold ${statusConfig.color.split(' ').slice(1).join(' ')} p-1 rounded-full">${task.status}</span>
                                <select
                                    onchange="updateTask(${day.dayIndex}, ${task.id}, 'status', this.value)"
                                    class="p-1 text-xs border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500"
                                >
                                    ${STATUS_OPTIONS.map(opt => `
                                        <option value="${opt.value}" ${task.status === opt.value ? 'selected' : ''}>
                                            ${opt.name}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                }).join('');
                
                const dayHeaderColor = day.diaSemana === 'Dom' || day.diaSemana === 'Sáb' ? 'bg-red-100/80 text-red-800' : 'bg-indigo-100/80 text-indigo-800';
                
                // Determina a cor da borda do card com base nas tarefas. Se houver alguma não executada, é 'Em Andamento', senão 'Executada'.
                const cardBorderStatus = day.tarefas.length > 0 ? day.tarefas.find(t => t.status !== 'Executada') ? 'Em Andamento' : 'Executada' : '';

                return `
                    <div class="bg-white p-4 rounded-xl shadow-xl task-card ${getTaskCardColor(cardBorderStatus)}">
                        <div class="p-2 mb-3 rounded font-extrabold text-center ${dayHeaderColor} flex-shrink-0">
                            ${day.diaSemana} - ${day.dataFormatada}
                        </div>
                        
                        <div class="flex-grow space-y-3 overflow-y-auto task-scroll-area pr-2">
                            ${tasksHtml.length > 0 ? tasksHtml : '<p class="text-sm text-gray-500 italic text-center p-4">Nenhuma tarefa registrada.</p>'}
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-gray-300 flex-shrink-0">
                            <input
                                type="text"
                                id="new-task-input-${day.dayIndex}"
                                placeholder="Nova tarefa..."
                                onkeydown="if(event.key === 'Enter') addTask(${day.dayIndex})"
                                class="w-full p-2 mb-2 border border-gray-300 rounded text-sm focus:ring-indigo-500 focus:border-indigo-500"
                            />
                            <button
                                onclick="addTask(${day.dayIndex})"
                                class="w-full p-2 text-sm bg-indigo-500 text-white font-semibold rounded hover:bg-indigo-600 transition"
                            >
                                + Adicionar Tarefa
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };


        // --- RENDERIZAÇÃO PRINCIPAL DA APLICAÇÃO ---

        const renderApplication = () => {
            const gridContainer = document.getElementById('tasks-grid');
            const dashboardContainer = document.getElementById('dashboard-container');
            const loadingIndicator = document.getElementById('loading-initial');
            
            if (loadingIndicator) loadingIndicator.remove();
            
            if (!isAppReady) {
                 gridContainer.innerHTML = `<div class="text-center p-10 text-lg font-medium text-indigo-600">Inicializando painel...</div>`;
                 return;
            }
            
            // 1. Calcula KPIs
            const kpis = calculateTaskKPIs(dailyTasks);

            // 2. Renderiza o Dashboard
            dashboardContainer.innerHTML = renderTaskDashboard(kpis);
            
            // 3. Renderiza a Grade de Tarefas
            gridContainer.innerHTML = renderTasksGrid(dailyTasks);
        };
        
        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        const initializeApplication = () => {
            // 1. Carrega o estado salvo localmente
            loadDataFromLocalStorage();
            
            // 2. Define que a aplicação está pronta (isAppReady)
            isAppReady = true;

            // 3. Renderiza a interface
            renderApplication();
        };

        // Inicializa a aplicação quando a janela estiver carregada
        window.onload = initializeApplication;
    </script>
</body>
</html>
